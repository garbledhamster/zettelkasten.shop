<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="A dedicated Zettelkasten store offering premium notecards, containers, pens, and accessories for organizing your thoughts.">
    <title>Zettelkasten Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6/dist/tippy.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glider-js@1/glider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/glider-js@1/glider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .primary-btn {
            background-color: #10b981;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .primary-btn:hover {
            background-color: #059669;
        }

        .product-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }

        .footer {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 20px 0;
        }

        .product-card img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background-color: #fff;
        }

        #auth-modal,
        #cart-modal,
        #options-modal {
            display: none;
            position: fixed;
            background: rgba(0, 0, 0, 0.5);
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #auth-modal > div,
        #cart-modal > div,
        #options-modal > div {
            background: #fff;
            padding: 20px;
            width: 300px;
            border-radius: 8px;
        }

        .auth-toggle {
            cursor: pointer;
            color: #10b981;
            font-weight: 600;
            text-decoration: underline;
        }

        .google-btn {
            display: flex;
            align-items: center;
            background: #fff;
            color: #000;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .google-btn img {
            width: 20px;
            margin-right: 10px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-right: 10px;
        }

        #user-status {
            margin-right: 10px;
            color: #10b981;
            font-weight: 600;
        }

        #user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        #user-avatar svg {
            width: 24px;
            height: 24px;
            stroke: #333;
        }

        /* Additional spacing for better UX */
        #contact-form .form-check {
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <header class="bg-dark text-white py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="h3">Zettelkasten Store</h1>
            <nav>
                <ul class="nav">
                    <li class="nav-item"><a href="#about" class="nav-link text-white">About</a></li>
                    <li class="nav-item"><a href="#products" class="nav-link text-white">Products</a></li>
                    <li class="nav-item"><a href="#contact" class="nav-link text-white">Contact</a></li>
                </ul>
            </nav>
            <div class="d-flex align-items-center">
                <div id="user-avatar" style="display:none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-user">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div id="user-status"></div>
                <!-- Modified button -->
                <button class="primary-btn me-2" id="login-logout-btn" onclick="toggleAuthModal()">Login/Register</button>
                <button class="primary-btn" onclick="toggleCartModal()">Cart</button>
            </div>
        </div>
    </header>

    <main class="container my-5">
        <section id="hero" class="text-center py-5">
            <h2 class="mb-4" id="hero-heading"></h2>
            <p class="mb-4" id="hero-text"></p>
            <button class="primary-btn" onclick="showOffer()">Special Offer</button>
        </section>

        <section id="about" class="my-5 text-center">
            <h3 class="mb-4">About Us</h3>
            <p id="about-text"></p>
        </section>

        <!-- Filter Section for categories -->
        <section class="my-5" id="filter-section">
            <h3 class="text-center mb-4">Filter by Category</h3>
            <div class="d-flex flex-wrap justify-content-center" id="category-filters">
                <!-- Checkboxes will be inserted here by JS -->
            </div>
        </section>

        <section id="products" class="my-5">
            <h3 class="text-center mb-4">Our Products</h3>
            <div class="row g-4" id="product-list"></div>
        </section>

        <section id="contact" class="my-5">
            <h3 class="text-center mb-4">Contact & Support</h3>
            <p class="text-center mb-4" id="contact-mission"></p>
            <p class="text-center mb-4" id="contact-description"></p>
            <form action="https://formspree.io/f/YOUR_FORMSPREE_ID" method="POST" id="contact-form">
                <div class="mb-3">
                    <p>Select a category: <span class="text-danger">*</span></p>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="üì¨ Return" id="catReturn" required>
                        <label class="form-check-label" for="catReturn">üì¨ Return</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="‚≠ê Site Feature Request" id="catFeature">
                        <label class="form-check-label" for="catFeature">‚≠ê Site Feature Request</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="üòä Feedback" id="catFeedback">
                        <label class="form-check-label" for="catFeedback">üòä Feedback</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="‚ùì Question" id="catQuestion">
                        <label class="form-check-label" for="catQuestion">‚ùì Question</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="category" value="üìÉ Other" id="catOther">
                        <label class="form-check-label" for="catOther">üìÉ Other</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="messageContact" class="form-label">Message</label>
                    <textarea class="form-control" name="message" id="messageContact" rows="3"
                        placeholder="Describe your issue or request here..." required></textarea>
                </div>
                <input type="hidden" name="_subject" value="Contact Request">
                <input type="hidden" name="email" id="hiddenUserEmail">
                <button type="submit" class="primary-btn">Send</button>
            </form>
        </section>
    </main>

    <footer class="footer text-center">
        <p>&copy; 2024 Zettelkasten Store. All rights reserved.</p>
        <div>
            <i data-feather="facebook"></i>
            <i data-feather="twitter"></i>
            <i data-feather="instagram"></i>
        </div>
    </footer>

    <div id="auth-modal">
        <div>
            <h3 class="mb-3">Login / Register</h3>
            <div class="google-btn" id="google-signin-btn">
                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_64dp.png" alt="Google icon" />
                <span>Sign in with Google</span>
            </div>
            <hr class="my-3">
            <div id="auth-forms">
                <div id="login-form">
                    <h5>Login with Email</h5>
                    <input class="form-control mb-2" id="loginEmail" type="email" placeholder="Email" />
                    <input class="form-control mb-2" id="loginPassword" type="password" placeholder="Password" />
                    <button class="primary-btn w-100 mb-2" id="login-btn">Login</button>
                    <p class="text-center">Don't have an account? <span class="auth-toggle" id="show-register">Register</span></p>
                </div>
                <div id="register-form" style="display:none;">
                    <h5>Register with Email</h5>
                    <input class="form-control mb-2" id="registerEmail" type="email" placeholder="Email" />
                    <input class="form-control mb-2" id="registerPassword" type="password" placeholder="Password" />
                    <button class="primary-btn w-100 mb-2" id="register-btn">Register</button>
                    <p class="text-center">Already have an account? <span class="auth-toggle" id="show-login">Login</span></p>
                </div>
            </div>
            <button class="btn btn-light w-100 mt-3" onclick="toggleAuthModal()">Close</button>
        </div>
    </div>

    <div id="cart-modal">
        <div>
            <h3>Your Cart</h3>
            <div id="cart-content"></div>
            <button class="primary-btn w-100 mb-2" id="checkout-btn">Checkout</button>
            <button class="btn btn-light w-100" onclick="toggleCartModal()">Close</button>
        </div>
    </div>

    <div id="options-modal">
        <div>
            <h3 id="options-modal-title">Select Options</h3>
            <div id="options-modal-content"></div>
            <div class="mb-3">
                <label for="variant-quantity" class="form-label">Quantity</label>
                <input type="number" id="variant-quantity" class="form-control" min="1" value="1">
            </div>
            <button class="primary-btn w-100 mb-2" id="confirm-options-btn">Add to Cart</button>
            <button class="btn btn-light w-100" onclick="toggleOptionsModal()">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js"
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js"

        const firebaseConfig = {
          apiKey: "AIzaSyCWSWj1zGd85SswT8FRBTHmlOFemBIbVdI",
          authDomain: "zettelkasten-shop.firebaseapp.com",
          projectId: "zettelkasten-shop",
          storageBucket: "zettelkasten-shop.firebasestorage.app",
          messagingSenderId: "671757800099",
          appId: "1:671757800099:web:c8a81ec0ade00765452516",
          measurementId: "G-VPBMF42BKN"
        };
        const app = initializeApp(firebaseConfig)
        const auth = getAuth(app)
        const db = getFirestore(app)
        feather.replace()

        let cart = []
        let productsArray = []
        let selectedProductIndex = null
        let bodyData = {}
        let allCategories = new Set();

        const pastelColors = ["#AEC6CF", "#F9D5E5", "#FDFD96", "#FFD1DC", "#77DD77", "#CDB7F6"]

        window.toggleAuthModal = function () {
            const m = document.getElementById('auth-modal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'
        }

        window.toggleCartModal = function () {
            const m = document.getElementById('cart-modal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
            updateCartDisplay()
        }

        window.toggleOptionsModal = function () {
            const m = document.getElementById('options-modal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'
        }

        window.showOptionsModal = function (i) {
            selectedProductIndex = i; 
            const p = productsArray[i]; 
            const o = document.getElementById('options-modal-content'); 
            const t = document.getElementById('options-modal-title'); 
            t.textContent = `Select Options for ${p.name}`; 
            o.innerHTML = ''; 
            if (p.variants && p.variants.length > 0) { 
                p.variants.forEach((v, x) => { 
                    const vid = `variant-option-${x}`; 
                    const vr = document.createElement('div'); 
                    vr.className = 'form-check mb-2'; 
                    vr.innerHTML = `<input class="form-check-input" type="radio" name="variant" id="${vid}" value="${x}" ${x === 0 ? 'checked' : ''}><label class="form-check-label" for="${vid}">${v.name} - $${v.price.toFixed(2)}</label>`; 
                    o.appendChild(vr) 
                }) 
            } else { 
                const vr = document.createElement('div'); 
                vr.textContent = "No variants available. You'll be adding the main product."; 
                o.appendChild(vr) 
            }
            document.getElementById('variant-quantity').value = 1; 
            toggleOptionsModal()
        }

        window.addToCart = function (i) { showOptionsModal(i) }

        document.getElementById('confirm-options-btn').addEventListener('click', () => {
            if (selectedProductIndex === null) return; 
            const p = productsArray[selectedProductIndex]; 
            const q = parseInt(document.getElementById('variant-quantity').value, 10) || 1; 
            let sv = null; 
            if (p.variants && p.variants.length > 0) { 
                const c = document.querySelector('input[name="variant"]:checked'); 
                if (c) { 
                    const vi = parseInt(c.value, 10); 
                    sv = p.variants[vi] 
                } 
            }
            const i = { name: sv ? `${p.name} - ${sv.name}` : p.name, image: sv ? sv.image : p.image, price: sv ? sv.price : p.price, quantity: q }; 
            cart.push(i); 
            Swal.fire({ title: 'Item Added!', text: `${i.name} (x${q}) has been added to your cart.`, icon: 'success', confirmButtonText: 'Continue Shopping' }); 
            updateCartDisplay(); 
            toggleOptionsModal(); 
            selectedProductIndex = null
        })

        function updateCartDisplay() {
            const c = document.getElementById('cart-content');
            c.innerHTML = ''; 
            if (cart.length === 0) { 
                c.innerHTML = '<p>Your cart is empty.</p>'; 
                return 
            }
            cart.forEach(i => {
                const d = document.createElement('div');
                d.className = 'cart-item';
                d.innerHTML = `<img src="${i.image}" alt="${i.name}"><span>${i.name} - $${i.price.toFixed(2)} (x${i.quantity})</span>`;
                c.appendChild(d) 
            })
        }

        window.showOffer = function () { 
            Swal.fire({ 
                title: bodyData.specialOfferTitle, 
                text: bodyData.specialOfferText, 
                icon: 'info', 
                confirmButtonText: 'Shop Now' 
            }) 
        }

        document.getElementById('checkout-btn').addEventListener('click', async () => { 
            const u = auth.currentUser; 
            if (!u) { 
                Swal.fire({ 
                    title: 'Not Logged In', 
                    text: 'Please log in or register to checkout.', 
                    icon: 'info', 
                    confirmButtonText: 'OK' 
                }); 
                return 
            } 
            if (cart.length === 0) { 
                Swal.fire('Your cart is empty.'); 
                return 
            } 
            try { 
                await addDoc(collection(db, 'orders'), { userId: u.uid, cart: cart, timestamp: new Date() }); 
                Swal.fire('Checkout successful! Your order will ship in 7-10 days with free shipping.'); 
                cart = []; 
                updateCartDisplay(); 
                toggleCartModal() 
            } catch (e) { 
                Swal.fire('Error', e.message, 'error') 
            }
        })

        const showLoginBtn = document.getElementById('show-login')
        const showRegisterBtn = document.getElementById('show-register')
        const loginForm = document.getElementById('login-form')
        const registerForm = document.getElementById('register-form')

        showLoginBtn.addEventListener('click', () => { 
            loginForm.style.display = 'block'; 
            registerForm.style.display = 'none' 
        })

        showRegisterBtn.addEventListener('click', () => { 
            loginForm.style.display = 'none'; 
            registerForm.style.display = 'block' 
        })

        const loginBtn = document.getElementById('login-btn')
        const registerBtn = document.getElementById('register-btn')

        registerBtn.addEventListener('click', async () => {
            const e = document.getElementById('registerEmail').value;
            const p = document.getElementById('registerPassword').value;
            try {
                const uc = await createUserWithEmailAndPassword(auth, e, p);
                const u = uc.user;
                const rc = pastelColors[Math.floor(Math.random() * pastelColors.length)];
                await setDoc(doc(db, "users", u.uid), { avatarColor: rc });
                Swal.fire('Registration successful! üéâ');
                toggleAuthModal();
                updateUserStatus()
            } catch (er) {
                Swal.fire('Error', er.message, 'error')
            }
        })

        loginBtn.addEventListener('click', async () => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, e, p);
                Swal.fire('Login successful! üéâ');
                toggleAuthModal();
                updateUserStatus()
            } catch (er) {
                Swal.fire('Error', er.message, 'error')
            }
        })

        const googleBtn = document.getElementById('google-signin-btn')
        const provider = new GoogleAuthProvider()
        googleBtn.addEventListener('click', async () => {
            try {
                const r = await signInWithPopup(auth, provider);
                const u = r.user;
                const ur = doc(db, "users", u.uid);
                const us = await getDoc(ur);
                if (!us.exists()) {
                    const rc = pastelColors[Math.floor(Math.random() * pastelColors.length)];
                    await setDoc(ur, { avatarColor: rc })
                }
                Swal.fire('Google sign-in successful! üéâ');
                toggleAuthModal();
                updateUserStatus()
            } catch (er) {
                Swal.fire('Error', er.message, 'error')
            }
        })

        async function updateUserStatus() {
            const s = document.getElementById('user-status');
            const a = document.getElementById('user-avatar');
            const loginLogoutBtn = document.getElementById('login-logout-btn');
            const u = auth.currentUser;
            if (u) {
                s.textContent = `Logged in as ${u.email}`;
                const ur = doc(db, "users", u.uid);
                const us = await getDoc(ur);
                if (us.exists()) {
                    const d = us.data();
                    const c = d.avatarColor || '#AEC6CF';
                    a.style.backgroundColor = c;
                    a.style.display = 'flex'
                } else {
                    a.style.display = 'none'
                }

                const hiddenEmail = document.getElementById('hiddenUserEmail');
                if (hiddenEmail) {
                    hiddenEmail.value = u.email;
                }

                // When logged in, show "Logout"
                loginLogoutBtn.textContent = "Logout";
                loginLogoutBtn.onclick = async () => {
                    await signOut(auth);
                };

            } else {
                s.textContent = '';
                a.style.display = 'none'

                // When logged out, show "Login/Register"
                loginLogoutBtn.textContent = "Login/Register";
                loginLogoutBtn.onclick = () => {
                    toggleAuthModal();
                };
            }
        }

        onAuthStateChanged(auth, (u) => { updateUserStatus() })

        let allProducts = [];

        fetch('products.json')
            .then(r => r.json())
            .then(products => {
                productsArray = products;
                allProducts = products; 
                products.forEach(p => {
                    p.categories.forEach(cat => allCategories.add(cat));
                });
                renderCategoryFilters();
                renderProducts(productsArray);
            })
            .catch(e => console.error('Error loading products:', e))

        fetch('body.json')
            .then(r => r.json())
            .then(d => {
                bodyData = d;
                document.getElementById('hero-heading').textContent = d.heroTitle;
                document.getElementById('hero-text').textContent = d.heroText;
                document.getElementById('about-text').textContent = d.aboutText;
                document.getElementById('contact-description').textContent = d.contactDescription;
                document.getElementById('contact-mission').textContent = d.mission
            })
            .catch(e => console.error('Error loading body text:', e))

        // Contact form submission with auth check
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            const u = auth.currentUser;
            if (!u) {
                e.preventDefault();
                Swal.fire({
                    title: 'Not Signed In',
                    text: 'You must be signed in to submit a contact request.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }

            const selectedCategory = this.querySelector('input[name="category"]:checked');
            if (!selectedCategory) {
                e.preventDefault();
                Swal.fire({
                    title: 'Category Required',
                    text: 'Please select a category before submitting your message.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                return;
            }

            const subjectInput = this.querySelector('input[name="_subject"]');
            subjectInput.value = `Contact Request - ${selectedCategory.value}`;
        });

        function renderCategoryFilters() {
            const container = document.getElementById('category-filters');
            container.innerHTML = '';
            allCategories.forEach(cat => {
                const id = `cat-filter-${cat}`;
                const cb = document.createElement('div');
                cb.className = 'form-check form-check-inline m-2';
                cb.innerHTML = `
                    <input class="form-check-input" type="checkbox" id="${id}" value="${cat}">
                    <label class="form-check-label" for="${id}">${cat}</label>
                `;
                container.appendChild(cb);
            });

            const filterBtn = document.createElement('button');
            filterBtn.className = 'primary-btn m-2';
            filterBtn.textContent = 'Filter';
            filterBtn.addEventListener('click', applyCategoryFilter);
            container.appendChild(filterBtn);

            const resetBtn = document.createElement('button');
            resetBtn.className = 'btn btn-light m-2';
            resetBtn.textContent = 'Reset Filters';
            resetBtn.addEventListener('click', () => {
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                renderProducts(allProducts);
            });
            container.appendChild(resetBtn);
        }

        function applyCategoryFilter() {
            const selectedCats = Array.from(document.querySelectorAll('#category-filters input[type="checkbox"]:checked'))
                                     .map(cb => cb.value);
            if (selectedCats.length === 0) {
                renderProducts(allProducts);
                return;
            }

            const filtered = allProducts.filter(p => {
                return p.categories.some(cat => selectedCats.includes(cat));
            });
            renderProducts(filtered);
        }

        function renderProducts(products) {
            const pl = document.getElementById('product-list');
            pl.innerHTML = '';
            productsArray = products;
            products.forEach((p, i) => {
                const c = document.createElement('div');
                c.classList.add('col-md-4');
                c.innerHTML = `
                    <div class="product-card">
                        <img src="${p.image}" alt="${p.name}">
                        <div class="p-3">
                            <h5>${p.name}</h5>
                            <p>${p.description}</p>
                            <p><strong>$${p.price.toFixed(2)}</strong></p>
                            <p><em>Ships in 7-10 days depending...</em></p>
                            <button class="primary-btn w-100" onclick="addToCart(${allProducts.indexOf(p)})">Add to Cart</button>
                        </div>
                    </div>`;
                pl.appendChild(c)
            })
        }

    </script>
</body>
</html>
